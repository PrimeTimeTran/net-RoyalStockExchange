IF EXISTS (SELECT *
FROM sys.objects
WHERE object_id = OBJECT_ID(N'[dbo].[GenerateTimePeriod]') AND type = N'P')
    DROP PROCEDURE [dbo].[GenerateTimePeriod];
GO

CREATE PROCEDURE [dbo].[GenerateTimePeriod]
    @userId INT,
    @startTime DATETIME,
    @endTime DATETIME,
    @endPrice DECIMAL(18, 2),
    @columnName VARCHAR(50)
AS
BEGIN
    -- Declare variables
    DECLARE @timeSeries TABLE (
        [time] DATETIME,
        [value] DECIMAL(18, 2)
    );
    DECLARE @previousPrice DECIMAL(18, 2) = @endPrice;
    DECLARE @timeIncrement INT;
    DECLARE @priceFluctuation DECIMAL(18, 2);
    DECLARE @i INT = 1;
    DECLARE @intervals INT = 288;

    -- Set time increment and price fluctuation based on the column name
    IF @columnName IN ('Live', 'OneDay')
        SET @timeIncrement = 5; -- 5 minutes
    ELSE IF @columnName IN ('OneWeek', 'OneMonth')
        SET @timeIncrement = 60; -- 1 hour
    ELSE
        SET @timeIncrement = 1440; -- 1 day

    -- Loop to generate time series data
    WHILE @startTime <= @endTime
    BEGIN
        SET @priceFluctuation = @previousPrice * (RAND() * 0.015 - 0.005);
        SET @previousPrice = ROUND(@previousPrice + @priceFluctuation, 2);

        IF @columnName IN ('Live', 'OneDay')
        BEGIN
            INSERT INTO @timeSeries ([time], [value])
            VALUES (DATEADD(MINUTE, @timeIncrement, @startTime), @previousPrice);
            SET @startTime = DATEADD(MINUTE, @timeIncrement, @startTime);
        END
        ELSE IF @columnName IN ('OneWeek', 'OneMonth')
        BEGIN
            INSERT INTO @timeSeries ([time], [value])
            VALUES (DATEADD(HOUR, @timeIncrement, @startTime), @previousPrice);
            SET @startTime = DATEADD(HOUR, @timeIncrement, @startTime);
        END
        ELSE IF @columnName IN ('ThreeMonths', 'YTD', 'OneYear', 'AllData')
        BEGIN
            INSERT INTO @timeSeries ([time], [value])
            VALUES (DATEADD(DAY, @timeIncrement, @startTime), @previousPrice);

            SET @startTime = DATEADD(DAY, @timeIncrement, @startTime);
        END

        SET @i += 1;
    END;

    DECLARE @jsonArray NVARCHAR(MAX);
    SET @jsonArray = (
        SELECT [time] AS [time], [value] AS [value]
        FROM @timeSeries
        FOR JSON PATH
    );

    DECLARE @sql NVARCHAR(MAX) = N'
        UPDATE [Portfolios]
        SET ' + QUOTENAME(@columnName) + ' = @jsonArray
        WHERE UserId = @userId;
    ';
    print 'hello';

    EXEC sp_executesql @sql, N'@userId INT, @jsonArray NVARCHAR(MAX)', @userId = @userId, @jsonArray = @jsonArray;
END;

